name: 定时下载并合并文本文件

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  download-and-merge:
    runs-on: ubuntu-latest
    # 授予写入权限，避免推送失败
    permissions:
      contents: write
    steps:
      - name: 检出仓库代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 初始化下载目录
        run: |
          # 创建统一的下载目录
          mkdir -p downloaded_files
          # 确保unzip工具已安装（Ubuntu默认有，兜底处理）
          sudo apt-get update && sudo apt-get install -y unzip

      - name: 下载并解压指定ZIP文件
        env:
          # 定义需要下载的ZIP文件URL列表
          ZIP_URL_LIST: |
            https://www.mmccants.org/tles/classfd.zip
            https://www.mmccants.org/tles/inttles.zip
        run: |
          # 循环处理每个ZIP URL
          for zip_url in $ZIP_URL_LIST; do
            # 1. 生成ZIP文件对应的本地保存名
            zip_filename=$(echo "$zip_url" | sed -e 's/[\/\?\&=:]/_/g' -e 's/__*/_/g' -e 's/_$//').zip
            zip_save_path="downloaded_files/$zip_filename"
            
            # 2. 下载ZIP文件
            echo "正在下载ZIP: $zip_url -> $zip_save_path"
            if wget -q -O "$zip_save_path" "$zip_url"; then
              echo "ZIP下载成功: $zip_filename"
              
              # 3. 解压ZIP文件到临时目录（避免和其他文件冲突）
              unzip_temp_dir="downloaded_files/zip_temp_$(date +%s)"
              mkdir -p "$unzip_temp_dir"
              if unzip -q "$zip_save_path" -d "$unzip_temp_dir"; then
                echo "ZIP解压成功: $zip_filename"
                
                # 4. 生成对应URL的TXT文件名（和原有逻辑一致）
                txt_filename=$(echo "$zip_url" | sed -e 's/[\/\?\&=:]/_/g' -e 's/__*/_/g' -e 's/_$//').txt
                txt_save_path="downloaded_files/$txt_filename"
                
                # 5. 将解压后的所有文件内容合并到该TXT文件
                > "$txt_save_path" # 清空目标TXT
                for unzipped_file in "$unzip_temp_dir"/*; do
                  if [ -f "$unzipped_file" ]; then
                    cat "$unzipped_file" >> "$txt_save_path"
                    echo -e "\n" >> "$txt_save_path" # 解压文件间加空行分隔
                  fi
                done
                echo "解压内容已写入: $txt_filename"
                
                # 清理临时文件
                rm -rf "$unzip_temp_dir"
                rm -f "$zip_save_path" # 删除已解压的ZIP文件
              else
                echo "ZIP解压失败，跳过: $zip_url"
                rm -rf "$unzip_temp_dir"
                rm -f "$zip_save_path"
              fi
            else
              echo "ZIP下载失败，跳过: $zip_url"
              rm -f "$zip_save_path"
            fi
          done

      - name: 下载多个文本URL文件
        env:
          # 在这里修改你要下载的文本URL列表
          URL_LIST: |
            https://r4uab.ru/satonline.txt
            https://amsat.org/tle/current/nasabare.txt
            https://celestrak.org/NORAD/elements/gp.php?GROUP=active&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=amateur&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=visual&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=cubesat&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=education&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=engineering&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=geo&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=globalstar&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=gnss&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=intelsat&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=iridium-NEXT&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=military&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=last-30-days&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=oneweb&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=orbcomm&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=resource&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=satnogs&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=science&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=spire&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=starlink&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=swarm&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=weather&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=x-comm&FORMAT=tle
            https://amsat.org/tle/current/nasabare.txt
            https://r4uab.ru/satonline.txt
        run: |
          # 循环处理每个文本URL（原有逻辑保留）
          for url in $URL_LIST; do
            filename=$(echo "$url" | sed -e 's/[\/\?\&=:]/_/g' -e 's/__*/_/g' -e 's/_$//').txt
            echo "正在下载文本: $url -> $filename"
            if wget -q -O "downloaded_files/$filename" "$url"; then
              echo "文本下载成功: $filename"
            else
              echo "文本下载失败，跳过: $url"
              rm -f "downloaded_files/$filename"
            fi
          done

      - name: 合并所有文件到allinone.txt
        run: |
          # 清空旧文件，仅保留纯内容
          > allinone.txt
          
          # 合并downloaded_files下所有TXT文件（包括ZIP解压生成的和直接下载的）
          for file in downloaded_files/*.txt; do
            if [ -f "$file" ]; then
              cat "$file" >> allinone.txt
              # 可选：如需文件间加空行分隔，取消下面注释
              # echo -e "\n" >> allinone.txt
            fi
          done
          
          # 清理临时目录
          rm -rf downloaded_files

      - name: Commit and push changes
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          if git status --porcelain | grep -q "allinone.txt"; then
            git add allinone.txt
            git commit -m "Update allinone.txt: $(date +'%Y-%m-%d %H:%M:%S')"
            git push
            echo "Successfully pushed allinone.txt to repository"
          else
            echo "No changes to allinone.txt, skip commit"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
