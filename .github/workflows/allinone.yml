name: 定时下载并合并文本文件

# 触发条件：每30分钟 + 手动触发（方便测试）
on:
  schedule:
    # cron表达式：分 时 日 月 周，*/30表示每30分钟
    - cron: '*/30 * * * *'
  workflow_dispatch: # 手动触发按钮

# 工作任务定义
jobs:
  download-and-merge:
    runs-on: ubuntu-latest # 使用Ubuntu系统的运行环境
    steps:
      # 步骤1：检出仓库代码（否则无法提交文件）
      - name: 检出仓库代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 拉取完整历史，避免提交失败

      # 步骤2：定义要下载的URL列表，下载并生成合法文件名
      - name: 下载多个文本文件
        env:
          # 在这里添加/修改你要下载的URL，每行一个
          URL_LIST: |
            https://tle.486520.xyz/https://celestrak.org/NORAD/elements/gp.php?GROUP=active&FORMAT=tle
            https://tle.486520.xyz/https://amsat.org/tle/current/nasabare.txt
            https://tle.486520.xyz/https://r4uab.ru/satonline.txt
        run: |
          # 创建临时目录存放下载的文件（避免和仓库文件冲突）
          mkdir -p downloaded_files
          
          # 循环处理每个URL
          for url in $URL_LIST; do
            # 将URL中的特殊字符（/、?、&、=等）替换为下划线，生成合法文件名
            filename=$(echo "$url" | sed -e 's/[\/\?\&=:]/_/g' -e 's/__*/_/g' -e 's/_$//').txt
            
            # 下载URL内容到指定文件，失败时跳过该URL（避免整个流程中断）
            echo "正在下载: $url -> $filename"
            if wget -q -O "downloaded_files/$filename" "$url"; then
              echo "下载成功: $filename"
            else
              echo "下载失败，跳过: $url"
              rm -f "downloaded_files/$filename" # 删除空文件
            fi
          done

      # 步骤3：合并所有下载的文件到allinone.txt
      - name: 合并文件到allinone.txt
        run: |
          # 清空旧的allinone.txt（如果存在）
          > allinone.txt
          
          # 写入合并说明（可选，方便查看）
          echo "===== 合并时间: $(date '+%Y-%m-%d %H:%M:%S') =====" >> allinone.txt
          echo "" >> allinone.txt
          
          # 循环合并每个下载的文件，添加分隔符便于区分
          for file in downloaded_files/*.txt; do
            if [ -f "$file" ]; then # 确保文件存在
              echo "===== 来源文件: $(basename "$file") =====" >> allinone.txt
              cat "$file" >> allinone.txt
              echo -e "\n\n" >> allinone.txt # 每个文件内容后加空行分隔
            fi
          done
          
          # 删除临时目录（可选，避免提交无关文件）
          rm -rf downloaded_files

      # 步骤4：提交并推送allinone.txt到仓库
      - name: 提交并推送文件
        env:
          # 设置git提交的用户信息（GitHub Action需要）
          GITHUB_USER: ${{ github.actor }}
          GITHUB_EMAIL: ${{ github.actor }}@users.noreply.github.com
        run: |
          # 配置git用户
          git config --global user.name "$GITHUB_USER"
          git config --global user.email "$GITHUB_EMAIL"
          
          # 检查文件是否有变化（避免空提交）
          if git status --porcelain | grep -q "allinone.txt"; then
            # 提交文件
            git add allinone.txt
            git commit -m "自动更新：合并下载的文本文件 $(date '+%Y-%m-%d %H:%M:%S')"
            # 推送提交到仓库
            git push origin main # 如果你的主分支是master，替换为master
            echo "文件已成功提交并推送"
          else
            echo "文件无变化，无需提交"
          fi
