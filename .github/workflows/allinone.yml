name: 定时下载并合并文本文件

# 触发条件：每30分钟 + 手动触发（方便测试）
on:
  schedule:
    # cron表达式：分 时 日 月 周，*/30表示每30分钟
    - cron: '*/30 * * * *'
  workflow_dispatch: # 手动触发按钮
permissions:
  contents: write # 授予内容写入权限

# 工作任务定义
jobs:
  download-and-merge:
    runs-on: ubuntu-latest # 使用Ubuntu系统的运行环境
    steps:
      # 步骤1：检出仓库代码（否则无法提交文件）
      - name: 检出仓库代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 拉取完整历史，避免提交失败

      # 步骤2：定义要下载的URL列表，下载并生成合法文件名
      - name: 下载多个文本文件
        env:
          # 在这里添加/修改你要下载的URL，每行一个
          URL_LIST: |
            https://r4uab.ru/satonline.txt
            https://amsat.org/tle/current/nasabare.txt
        run: |
          # 创建临时目录存放下载的文件（避免和仓库文件冲突）
          mkdir -p downloaded_files
          
          # 循环处理每个URL
          for url in $URL_LIST; do
            # 将URL中的特殊字符（/、?、&、=等）替换为下划线，生成合法文件名
            filename=$(echo "$url" | sed -e 's/[\/\?\&=:]/_/g' -e 's/__*/_/g' -e 's/_$//').txt
            
            # 下载URL内容到指定文件，失败时跳过该URL（避免整个流程中断）
            echo "正在下载: $url -> $filename"
            if wget -q -O "downloaded_files/$filename" "$url"; then
              echo "下载成功: $filename"
            else
              echo "下载失败，跳过: $url"
              rm -f "downloaded_files/$filename" # 删除空文件
            fi
          done

      # 步骤3：合并所有下载的文件到allinone.txt
      - name: 合并文件到allinone.txt
        run: |
          # 清空旧的allinone.txt（如果存在）
          > allinone.txt
          
          
          # 循环合并每个下载的文件，添加分隔符便于区分
          for file in downloaded_files/*.txt; do
            if [ -f "$file" ]; then # 确保文件存在
              cat "$file" >> allinone.txt
            fi
          done
          
          # 删除临时目录（可选，避免提交无关文件）
          rm -rf downloaded_files

      # 步骤4：替换为你指定的提交方式
      - name: Commit and push changes
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          # 检查allinone.txt是否有变更，避免空提交
          if git status --porcelain | grep -q "allinone.txt"; then
            git add allinone.txt
            git commit -m "Update allinone.txt: $(date +'%Y-%m-%d %H:%M:%S')"
            git push
            echo "Successfully pushed allinone.txt to repository"
          else
            echo "No changes to allinone.txt, skip commit"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
