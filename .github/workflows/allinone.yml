name: 定时下载并合并文本文件

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  download-and-merge:
    runs-on: ubuntu-latest
    permissions:
      contents: write # 解决推送权限问题
    steps:
      - name: 检出仓库代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 新增：兜底安装unzip工具（即使Ubuntu默认有，确保环境兼容）
      - name: 安装unzip工具
        run: |
          echo "检查并安装unzip工具..."
          sudo apt-get update -y
          sudo apt-get install -y unzip
          # 验证安装成功
          unzip -v || echo "unzip安装失败（兜底处理）"

      - name: 初始化下载目录
        run: |
          # 创建目录（确保目录存在）
          mkdir -p downloaded_files
          # 清空目录（避免历史文件干扰）
          rm -rf downloaded_files/*

      - name: 下载并处理ZIP文件
        env:

          ZIP_URL_LIST: |
            https://www.mmccants.org/tles/classfd.zip
            https://www.mmccants.org/tles/inttles.zip

        run: |

          # 循环下载每个ZIP文件
          for zip_url in $ZIP_URL_LIST; do
            # 提取ZIP文件名（如classfd.zip）
            zip_filename=$(basename "$zip_url")
            zip_path="downloaded_files/$zip_filename"
            
            # 下载ZIP文件
            echo "正在下载ZIP文件: $zip_url -> $zip_path"
            if wget -q -O "$zip_path" "$zip_url"; then
              echo "ZIP下载成功: $zip_filename"
              
              # 解压ZIP到downloaded_files目录（覆盖已有文件，避免报错）
              echo "正在解压: $zip_filename"
              unzip -o "$zip_path" -d downloaded_files/
              
              # 删除已解压的ZIP文件（避免后续合并时处理ZIP）
              rm -f "$zip_path"
              echo "解压完成并删除ZIP: $zip_filename"
            else
              echo "ZIP下载失败，跳过: $zip_url"
              rm -f "$zip_path" # 删除空文件
            fi
          done
          
          # 将解压后的所有文件改后缀为.txt（排除可能残留的ZIP）
          echo "正在将解压文件改后缀为.txt"
          for file in downloaded_files/*; do
            # 跳过目录和ZIP文件，只处理普通文件
            if [ -f "$file" ] && [[ "$file" != *.zip ]]; then
              # 保留原文件名，仅改后缀为txt（如classfd -> classfd.txt）
              mv "$file" "${file%.*}.txt"
              echo "重命名: $file -> ${file%.*}.txt"
            fi
          done

      - name: 下载指定URL的文本文件
        env:
          # 你可自定义的TXT文件URL列表（和ZIP分开管理，更清晰）
          URL_LIST: |
            https://r4uab.ru/satonline.txt
            https://amsat.org/tle/current/nasabare.txt
            https://celestrak.org/NORAD/elements/gp.php?GROUP=active&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=amateur&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=visual&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=cubesat&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=education&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=engineering&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=geo&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=globalstar&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=gnss&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=intelsat&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=iridium-NEXT&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=military&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=last-30-days&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=oneweb&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=orbcomm&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=resource&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=satnogs&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=science&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=spire&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=starlink&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=swarm&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=weather&FORMAT=tle
            https://celestrak.org/NORAD/elements/gp.php?GROUP=x-comm&FORMAT=tle
        run: |
          # 循环处理每个TXT URL
          for url in $URL_LIST; do
            # 生成合法文件名（替换特殊字符）
            filename=$(echo "$url" | sed -e 's/[\/\?\&=:]/_/g' -e 's/__*/_/g' -e 's/_$//').txt
            file_path="downloaded_files/$filename"
            
            # 下载URL内容
            echo "正在下载文本文件: $url -> $filename"
            if wget -q -O "$file_path" "$url"; then
              echo "下载成功: $filename"
            else
              echo "下载失败，跳过: $url"
              rm -f "$file_path" # 删除空文件
            fi
          done

      - name: 合并所有txt文件到allinone.txt
        run: |
          # 清空旧文件
          > allinone.txt
          
          # 仅合并所有txt文件的纯内容（无额外说明）
          for file in downloaded_files/*.txt; do
            if [ -f "$file" ]; then
              cat "$file" >> allinone.txt
              # 可选：不同文件间加空行分隔，需要则取消注释
              # echo -e "\n" >> allinone.txt
            fi
          done
          
          # 删除临时目录
          rm -rf downloaded_files

      - name: Commit and push changes
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          if git status --porcelain | grep -q "allinone.txt"; then
            git add allinone.txt
            git commit -m "Update allinone.txt: $(date +'%Y-%m-%d %H:%M:%S')"
            git push
            echo "Successfully pushed allinone.txt to repository"
          else
            echo "No changes to allinone.txt, skip commit"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
